#!/usr/bin/env bash
set -euo pipefail

# === ВСТАВЬ СВОЙ ПУБЛИЧНЫЙ КЛЮЧ (одной строкой) ===
SSH_KEY='ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC1qxTyHZnW7sWE787PsyELOUae9jl6QqB75ICfCTJWQjNzAf+6V4ztwrSVECmbNoGKkOWIWwKqEoKQJUbFtquc2KVYsQRSZPneG5/0+rEM9cEuRmfa3u6U7T+N1bGuaYGfjLRUlAafhZfy2mVCVMpZyzdeOLjWJr7TbebIS+ZBVgcXVbDqpcs3RLGqlHM4dPAzyHtXwsbCZrk182yYdLY1amqKgYcE14zfD4ZaDI6FoxaBEUhpcZ5NDiGRL7k+nFsvz/L8xziRtOtnuQho+u7clqffReWt2M1wglUtWcn5U/JUDTgf39/CUkNcMZOdwDfbXMUD9T+AhlvPUz8j5jWMVYzmdbOPdJMAccx9P5yeuvNBrLmHufZNfpDj7F9aeRJjhXNXucHudwC+AiLzsntvbiZlR6aIQvJ8DWFknmynF5V62cp64pYlDWQwgQRljJ40ahT15trqIiis24wmYErjxp0kG3xhjFixwy8U3onbMD5UIf8ms4/ww4DglSUtBKE= dark'

# Целевой пользователь: если запущено через sudo — настраиваем юзера, который вызвал sudo
TARGET_USER="${SUDO_USER:-$(id -un)}"

# Домашняя директория пользователя на macOS
TARGET_HOME="$(dscl . -read "/Users/$TARGET_USER" NFSHomeDirectory 2>/dev/null | awk '{print $2}' || true)"
if [[ -z "${TARGET_HOME:-}" ]]; then
  TARGET_HOME="$(eval echo "~$TARGET_USER")"
fi
if [[ -z "${TARGET_HOME:-}" ]]; then
  echo "ERROR: cannot determine home directory for $TARGET_USER" >&2
  exit 1
fi

SSH_DIR="$TARGET_HOME/.ssh"
AUTH_KEYS="$SSH_DIR/authorized_keys"

echo "User: $TARGET_USER"
echo "Home: $TARGET_HOME"

# 1) Добавляем ключ в authorized_keys
mkdir -p "$SSH_DIR"
chmod 700 "$SSH_DIR"

touch "$AUTH_KEYS"
chmod 600 "$AUTH_KEYS"

# Если файл не пустой и без \n в конце — добавим перевод строки
if [[ -s "$AUTH_KEYS" ]] && [[ "$(tail -c 1 "$AUTH_KEYS" || true)" != $'\n' ]]; then
  printf '\n' >> "$AUTH_KEYS"
fi

# Добавим ключ только если его ещё нет
if ! grep -qxF "$SSH_KEY" "$AUTH_KEYS" 2>/dev/null; then
  printf '%s\n' "$SSH_KEY" >> "$AUTH_KEYS"
fi

# Поправим владельца (если запускали через sudo)
chown -R "$TARGET_USER:staff" "$SSH_DIR" 2>/dev/null || true

echo "OK: key ensured in $AUTH_KEYS"

# 2) Включаем Remote Login (sshd) в macOS
# (требует sudo)
if [[ "$(id -u)" -ne 0 ]]; then
  echo "NOTE: to enable Remote Login and edit sshd_config, run this script with sudo."
else
  echo "Enabling Remote Login (SSH)..."
  systemsetup -setremotelogin on >/dev/null

  # 3) Жёсткая настройка sshd_co_
