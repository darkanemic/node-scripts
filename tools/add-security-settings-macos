#!/usr/bin/env bash
set -euo pipefail

# === ВСТАВЬ СВОЙ ПУБЛИЧНЫЙ КЛЮЧ (одной строкой) ===
SSH_KEY='ssh-ed25519 AAAA... твой_ключ ... comment'

# Целевой пользователь: если запуск через sudo — настраиваем того, кто вызвал sudo
TARGET_USER="${SUDO_USER:-$(id -un)}"

# Домашняя директория пользователя на macOS
TARGET_HOME="$(dscl . -read "/Users/$TARGET_USER" NFSHomeDirectory 2>/dev/null | awk '{print $2}' || true)"
if [[ -z "${TARGET_HOME:-}" ]]; then
  TARGET_HOME="$(eval echo "~$TARGET_USER")"
fi
if [[ -z "${TARGET_HOME:-}" ]]; then
  echo "ERROR: cannot determine home directory for $TARGET_USER" >&2
  exit 1
fi

SSH_DIR="$TARGET_HOME/.ssh"
AUTH_KEYS="$SSH_DIR/authorized_keys"

echo "User: $TARGET_USER"
echo "Home: $TARGET_HOME"

# 1) Добавляем ключ в authorized_keys
mkdir -p "$SSH_DIR"
chmod 700 "$SSH_DIR"

touch "$AUTH_KEYS"
chmod 600 "$AUTH_KEYS"

# Если файл не пустой и без \n в конце — добавим перевод строки
if [[ -s "$AUTH_KEYS" ]] && [[ "$(tail -c 1 "$AUTH_KEYS" 2>/dev/null || true)" != $'\n' ]]; then
  printf '\n' >> "$AUTH_KEYS"
fi

# Добавим ключ только если его ещё нет (точное совпадение строки)
if ! grep -qxF "$SSH_KEY" "$AUTH_KEYS" 2>/dev/null; then
  printf '%s\n' "$SSH_KEY" >> "$AUTH_KEYS"
fi

# Поправим владельца (если запускали через sudo)
chown -R "$TARGET_USER:staff" "$SSH_DIR" 2>/dev/null || true

echo "OK: key ensured in $AUTH_KEYS"

# Ниже — системные настройки, требуют root
if [[ "$(id -u)" -ne 0 ]]; then
  echo "NOTE: run with sudo to enable Remote Login and harden sshd_config."
  exit 0
fi

# 2) Включаем Remote Login (SSHD)
echo "Enabling Remote Login (SSH)..."
systemsetup -setremotelogin on >/dev/null

# 3) Настраиваем sshd_config
SSHD_CONFIG="/etc/ssh/sshd_config"
BACKUP="/etc/ssh/sshd_config.bak.$(date +%Y%m%d%H%M%S)"
cp -a "$SSHD_CONFIG" "$BACKUP"
echo "Backup: $BACKUP"

set_sshd_opt() {
  local key="$1"
  local value="$2"
  if grep -Eq "^[#[:space:]]*${key}[[:space:]]+" "$SSHD_CONFIG"; then
    perl -0777 -i -pe "s/^[#\\s]*${key}\\s+.*\$/${key} ${value}/m" "$SSHD_CONFIG"
  else
    printf '\n%s %s\n' "$key" "$value" >> "$SSHD_CONFIG"
  fi
}

echo "Hardening sshd_config..."

# Только ключи
set_sshd_opt "PubkeyAuthentication" "yes"
set_sshd_opt "PasswordAuthentication" "no"
set_sshd_opt "KbdInteractiveAuthentication" "no"
set_sshd_opt "ChallengeResponseAuthentication" "no"

# Запрет root
set_sshd_opt "PermitRootLogin" "no"
set_sshd_opt "PermitEmptyPasswords" "no"

# Ограничения
set_sshd_opt "MaxAuthTries" "3"
set_sshd_opt "LoginGraceTime" "30"
set_sshd_opt "ClientAliveInterval" "300"
set_sshd_opt "ClientAliveCountMax" "2"

# Разрешить логин только этому пользователю (если хочешь разрешить всем — закомментируй)
set_sshd_opt "AllowUsers" "$TARGET_USER"

# Проверка конфига
/usr/sbin/sshd -t

# Перезапуск sshd
echo "Restarting sshd..."
launchctl stop com.openssh.sshd 2>/dev/null || true
launchctl start com.openssh.sshd

echo "OK: macOS SSH hardened. Only publickey login allowed for: $TARGET_USER"
