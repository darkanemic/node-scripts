#!/usr/bin/env bash
set -euo pipefail

# === ВСТАВЬ СВОЙ ПУБЛИЧНЫЙ КЛЮЧ (одной строкой) ===
SSH_KEY='ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAA_REPLACE_WITH_YOUR_REAL_KEY darkanemic@mac'

# Пользователь, которому разрешаем логин (если запускаешь через sudo — будет твой юзер)
ALLOW_USER="${SUDO_USER:-$(id -un)}"

# 1) Убедимся, что ключ есть у ALLOW_USER
USER_HOME="$(getent passwd "$ALLOW_USER" | cut -d: -f6)"
SSH_DIR="$USER_HOME/.ssh"
AUTH_KEYS="$SSH_DIR/authorized_keys"

install -d -m 700 -o "$ALLOW_USER" -g "$ALLOW_USER" "$SSH_DIR"
touch "$AUTH_KEYS"
chown "$ALLOW_USER:$ALLOW_USER" "$AUTH_KEYS"
chmod 600 "$AUTH_KEYS"

# Добавим перенос строки, если файла нет или он без \n в конце
if [[ -s "$AUTH_KEYS" ]] && [[ "$(tail -c 1 "$AUTH_KEYS" || true)" != $'\n' ]]; then
  printf '\n' >> "$AUTH_KEYS"
fi

if ! grep -qxF "$SSH_KEY" "$AUTH_KEYS"; then
  printf '%s\n' "$SSH_KEY" >> "$AUTH_KEYS"
fi

# 2) Настроим sshd через drop-in (предпочтительно)
SSHD_DIR="/etc/ssh/sshd_config.d"
HARD_FILE="$SSHD_DIR/99-hardening.conf"

mkdir -p "$SSHD_DIR"

# Бэкап базового конфига на всякий
if [[ -f /etc/ssh/sshd_config ]]; then
  cp -a /etc/ssh/sshd_config "/etc/ssh/sshd_config.bak.$(date +%Y%m%d%H%M%S)"
fi

cat > "$HARD_FILE" <<EOF
# Managed by hardening script: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
# Allow only key-based login for a single user.

Protocol 2
PubkeyAuthentication yes
PasswordAuthentication no
KbdInteractiveAuthentication no
ChallengeResponseAuthentication no
AuthenticationMethods publickey

PermitRootLogin no
PermitEmptyPasswords no

# Limit who can log in
AllowUsers $ALLOW_USER

# Use the standard authorized_keys
AuthorizedKeysFile .ssh/authorized_keys

# Basic hardening
X11Forwarding no
PermitTunnel no
AllowAgentForwarding no
AllowTcpForwarding no
MaxAuthTries 3
LoginGraceTime 30
ClientAliveInterval 300
ClientAliveCountMax 2
EOF

# 3) Проверим валидность конфига
sshd -t

# 4) Перезапуск sshd (в зависимости от системы)
if command -v systemctl >/dev/null 2>&1; then
  systemctl restart sshd 2>/dev/null || systemctl restart ssh
elif command -v service >/dev/null 2>&1; then
  service sshd restart 2>/dev/null || service ssh restart
else
  # fallback (редко)
  /etc/init.d/sshd restart 2>/dev/null || /etc/init.d/ssh restart
fi

echo "OK: SSH hardened. Only publickey login allowed for user: $ALLOW_USER"
echo "Config: $HARD_FILE"
